<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>FRP Asteroids | Good Times Paradigms</title>
<meta name="generator" content="Jekyll v4.4.1">
<meta property="og:title" content="FRP Asteroids">
<meta property="og:locale" content="en_US">
<meta name="description" content="Introduction">
<meta property="og:description" content="Introduction">
<meta property="og:site_name" content="Good Times Paradigms">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2025-09-30T03:56:06+00:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="FRP Asteroids">
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-09-30T03:56:06+00:00","datePublished":"2025-09-30T03:56:06+00:00","description":"Introduction","headline":"FRP Asteroids","mainEntityOfPage":{"@type":"WebPage","@id":"/asteroids/"},"url":"/asteroids/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="shortcut icon" href="/assets/images/favicon.ico">
    <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Good Times Paradigms"><!-- Global site tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-159840333-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-159840333-1');
</script><!-- MathJax v3 -->
<script>
  window.MathJax = {
    tex: { inlineMath: [['$','$'], ['\\(','\\)']], processEscapes: true }
  };
</script>
<script defer="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
  <script src="/assets/js/spoilers.js" defer=""></script></head>

  <body><header class="site-header">

    <div class="wrapper"><!-- Lambda icon and site title aligned left in a flex container -->
        <div style="display: flex; align-items: center;">
            <button id="play-theme-song" style="background:none;border:none;cursor:pointer;vertical-align:middle;margin-right:2px;" title="Play theme song">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="24" fill="currentColor" viewBox="0 0 48 24" style="vertical-align:middle;">
                    <text x="4" y="20" font-size="20" font-family="serif">ΓΤΠ</text>
                    <!-- γτπ -->
                </svg>
            </button>
            <a class="site-title" rel="author" href="/" style="margin:0;">Good Times Paradigms</a>
        </div>
        <script src="/assets/js/hide_solutions.js" defer=""></script>
        <audio id="theme-song" src="/assets/themesong.mp3"></audio>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var btn = document.getElementById('play-theme-song');
                var audio = document.getElementById('theme-song');
                btn.addEventListener('click', function() {
                    if (audio.paused) {
                        audio.play();
                    } else {
                        audio.pause();
                        audio.currentTime = 0;
                    }
                });
            });
        </script><nav class="site-nav">
            <input type="checkbox" id="nav-trigger" class="nav-trigger">
            <label for="nav-trigger">
                <span class="menu-icon">
                </span>
            </label>

            <div class="nav-items"><a class="page-link nav-item" href="/about/">About</a><a class="page-link nav-item" href="/">Notes on Programming Paradigms</a><!-- Radio Switch -->
                <div id="toggle-div" style="display: none;">
                    <div class="solutions-toggle">
                        <p class="page-link" style="margin-bottom: 0px;">Show Solutions?</p>
                        <label class="switch" style="vertical-align: middle;">
                            <input type="checkbox" id="toggle-switch">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
            </div>
        </nav></div>

</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">
	
  

  


<div id="pagination">
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
        
        
        <a id="left" href="/functionalreactiveprogramming/">&lt; <span class="glossary-term" data-term="functional">Functional<span class="glossary-popup">Functional languages are built around the concept of composable functions.  Such languages support <em>higher-order functions</em> which can take other functions as arguments or return new functions as their result, following the rules of the <em>Lambda Calculus</em>.
</span></span> Reactive Programming</a>
      
      
        
        
        <a id="right" href="/higherorderfunctions/"><span class="glossary-term" data-term="higher-order functions">Higher-Order Functions<span class="glossary-popup">A function that takes other functions as arguments or returns a function as its result.
</span></span> &gt;</a>
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</div>

	<header class="post-header">
		<h1 class="post-title">FRP Asteroids</h1>
	</header>
	<p id="readingTime">

  
  45

 min read</p>
	<div class="post-content">
		<h2 id="introduction">Introduction</h2>

<p><span class="glossary-term" data-term="functional">Functional<span class="glossary-popup">Functional languages are built around the concept of composable functions.  Such languages support <em>higher-order functions</em> which can take other functions as arguments or return new functions as their result, following the rules of the <em>Lambda Calculus</em>.
</span></span> Reactive Programming (specifically the <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span>/Observer pattern) allows us to capture <span class="glossary-term" data-term="asynchronous">asynchronous<span class="glossary-popup">Operations that occur independently of the main program flow, allowing the program to continue executing while waiting for the operation to complete.
</span></span> actions like user <span class="glossary-term" data-term="interface">interface<span class="glossary-popup">A TypeScript construct that defines the shape of an object, specifying the types of its properties and methods.
</span></span> events in streams.  These allow us to “linearise” the flow of control, avoid deeply nested loops, and process the stream with pure, referentially transparent functions.</p>

<p>As an example we will build a little “Asteroids” game using FRP.  We’re going to use <a href="https://rxjs.dev/">RxJS</a> as our <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> implementation, and we are going to render it in <span class="glossary-term" data-term="html">HTML<span class="glossary-popup">Hyper-Text Markup Language - the declarative language for specifying web page content.
</span></span> using <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span>.
We’re also going to take some pains to make pure <span class="glossary-term" data-term="functional">functional<span class="glossary-popup">Functional languages are built around the concept of composable functions.  Such languages support <em>higher-order functions</em> which can take other functions as arguments or return new functions as their result, following the rules of the <em>Lambda Calculus</em>.
</span></span> code (and lots of beautiful curried lambda (arrow) functions). We’ll use <a href="https://www.typescriptlang.org/">TypeScript <span class="glossary-term" data-term="type annotations">type annotations<span class="glossary-popup">A syntax in TypeScript where types are explicitly specified for variables, function parameters, and return types to ensure type safety and correctness.
</span></span></a> to help us ensure that our data is indeed immutable and to guide us in plugging everything together without type errors into a nicely decoupled <a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller">Model-View-Controller (MVC) architecture</a>:</p>

<p><img src="/assets/images/chapterImages/asteroids/generalMVC.png" alt="MVC Architecture"></p>

<p>If you’re the kind of person who likes to work backwards, <a href="https://stackblitz.com/edit/asteroids2023">you can jump straight to playing the final result</a> and you can also live edit its code.</p>

<p>We’ll build it up in several steps.</p>

<ul>
  <li>
    <p>First, we’ll just <a href="#rotating-the-ship">rotate the ship</a></p>

    <ol>
      <li><a href="#using-events-directly">directly with old-school events</a></li>
      <li><a href="#using-observable">abstracting away event handling with an <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span></a></li>
    </ol>
  </li>
  <li>Then, we’ll <a href="#pure-observable-streams">eliminate global mutable state using “Pure” <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> Streams</a></li>
  <li>Then, we’ll <a href="#adding-physics-and-handling-more-inputs">add physics and handle more inputs</a></li>
  <li>We’ll <a href="#view">isolate the view</a></li>
  <li>Next, we’ll <a href="#additional-objects">introduce other objects, starting with bullets</a></li>
  <li>Finally, we’ll <a href="#collisions">deal with collisions</a></li>
</ul>

<p>Let’s start by making the <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span> with a simple polygon for the ship.  It will look like this:</p>

<p><img src="/assets/images/chapterImages/asteroids/ship.png" alt="Ship"></p>

<p>And here’s the snippet of <span class="glossary-term" data-term="html">HTML<span class="glossary-popup">Hyper-Text Markup Language - the declarative language for specifying web page content.
</span></span> that creates the ship:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">"150"</span> <span class="na">height=</span><span class="s">"150"</span> <span class="na">style=</span><span class="s">"background-color:black"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;g</span> <span class="na">id=</span><span class="s">"ship"</span> <span class="na">transform=</span><span class="s">"translate(75,75)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;polygon</span> <span class="na">points=</span><span class="s">"-15,20 15,20 0,-20"</span>
                <span class="na">style=</span><span class="s">"fill:lightblue"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/polygon&gt;</span>
  <span class="nt">&lt;/g&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></div></div>

<p>Note that the ship is rendered inside a transform group <code class="language-plaintext highlighter-rouge">&lt;g&gt;</code>.  We will be changing the <code class="language-plaintext highlighter-rouge">transform</code> attribute to move the ship around.</p>

<h2 id="rotating-the-ship">Rotating the ship</h2>

<p>To begin with, we’ll make it possible for the player to rotate the ship with the arrow keys.  First, by directly adding listeners to keyboard events.  Then, by using events via <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> streams.  Here’s a preview of what it’s going to look like (<a href="https://stackblitz.com/edit/asteroids01">or you can play with it in a live editor</a>):</p>

<p><a href="https://stackblitz.com/edit/asteroids01"><img src="/assets/images/chapterImages/asteroids/asteroidsRotate.gif" alt="Rotation animation"></a></p>

<p>There are basically just two states, as sketched in the following state machine:</p>

<p><img src="/assets/images/chapterImages/asteroids/turnStateMachine.png" alt="Turn State Machine"></p>

<h1 id="using-events-directly">Using Events Directly</h1>

<p>The first event we assign a function to is the window load event.  This function will not be invoked until the page is fully loaded, and therefore the <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span> objects will be available.  Thus, our code begins:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">ship</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">ship</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
  <span class="p">...</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ship</code> will reference the <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span> <code class="language-plaintext highlighter-rouge">&lt;g&gt;</code> whose transform attribute we will be manipulating to move it.  To apply an incremental movement, such as rotating the ship by a certain angle relative to its current orientation, we will need to store that current location.  We could read it out of the transform attribute stored in the <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span>, but that requires some messy string parsing.  We’ll just store the state in a local object, which we will keep up to date as we move the ship.  For now, all we have is the ship’s position (x and y coordinates) and rotation angle:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="kd">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">x</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="na">angle</span><span class="p">:</span><span class="mi">0</span>
  <span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Next, we need to specify a function to be invoked on keydown events:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">onkeydown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">:</span><span class="nx">KeyboardEvent</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Inside this function, we are only interested in left and right arrow keys.  If the keys are held down, after a moment they may start repeating automatically (this is OS dependent) and will churn out continuous keydown events.  We filter these out too by inspecting the KeyboardEvent.repeat property:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
    <span class="k">if</span><span class="p">((</span><span class="nx">d</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">ArrowLeft</span><span class="dl">"</span> <span class="o">||</span> <span class="nx">d</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">ArrowRight</span><span class="dl">"</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">d</span><span class="p">.</span><span class="nx">repeat</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Let’s say we want a left- or right-arrow keydown event to start the ship rotating, and we want to keep rotating until the key is released.  To achieve this, we use the built-in <code class="language-plaintext highlighter-rouge">setInterval(f,i)</code> function, which invokes the function <code class="language-plaintext highlighter-rouge">f</code> repeatedly with the specified interval <code class="language-plaintext highlighter-rouge">i</code> delay (in milliseconds) between each invocation.  <code class="language-plaintext highlighter-rouge">setInterval</code> returns a numeric handle which we need to store so that we can clear the interval behaviour later.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="kd">const</span> <span class="nx">handle</span> <span class="o">=</span> <span class="nf">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">ship</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">transform</span><span class="dl">'</span><span class="p">,</span>
          <span class="s2">`translate(</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">,</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">) rotate(</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">angle</span><span class="o">+=</span><span class="nx">d</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">ArrowLeft</span><span class="dl">"</span> <span class="p">?</span> <span class="o">-</span><span class="mi">1</span> <span class="p">:</span> <span class="mi">1</span><span class="p">}</span><span class="s2">)`</span><span class="p">)</span>
        <span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
</code></pre></div></div>

<p>So as promised, this function is setting the <code class="language-plaintext highlighter-rouge">transform</code> property on the ship, using the position and angle information stored in our local <code class="language-plaintext highlighter-rouge">state</code> object.  We compute the new position by deducting or removing 1 (degree) from the angle (for a left or right rotation respectively) and simultaneously update the state object with the new angle.
Since we specify 10-millisecond delay, the ship will rotate 100 degrees per second.</p>

<p>We’re not done yet.  We have to stop the rotation on keyup by calling <code class="language-plaintext highlighter-rouge">clearInterval</code>, for the specific interval we just created on keydown (using the <code class="language-plaintext highlighter-rouge">handle</code> we stored).  To do this, we’ll use <code class="language-plaintext highlighter-rouge">document.addEventListener</code> to specify a separate keyup handler for each keydown event, and since we will be creating a new keyup listener for each keydown event, we will also have to cleanup after ourselves or we’ll have a memory (event) leak:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
      <span class="kd">const</span> <span class="nx">keyupListener</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">u</span><span class="p">:</span><span class="nx">KeyboardEvent</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">d</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">clearInterval</span><span class="p">(</span><span class="nx">handle</span><span class="p">);</span>
          <span class="nb">document</span><span class="p">.</span><span class="nf">removeEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span><span class="p">,</span><span class="nx">keyupListener</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">};</span>
      <span class="nb">document</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">keyup</span><span class="dl">"</span><span class="p">,</span><span class="nx">keyupListener</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And finally we’re done.  But it was surprisingly messy for what should be a relatively straightforward and commonplace interaction.  Furthermore, the <span class="glossary-term" data-term="imperative">imperative<span class="glossary-popup">Imperative programs are a sequence of statements that change a program’s state.  This is probably the dominant paradigm for programming languages today.  Languages from Assembly to Python are built around this concept and most modern languages still allow you to program in this style.
</span></span> style code above finished up deeply nested with function declarations inside function declarations, inside <code class="language-plaintext highlighter-rouge">if</code>s and variables like <code class="language-plaintext highlighter-rouge">d</code>, <code class="language-plaintext highlighter-rouge">handle</code> and <code class="language-plaintext highlighter-rouge">keyupListener</code> are referenced from inside these nested function scopes in ways that are difficult to read and make sense of.  The state machine is relatively straightforward, but it’s tangled up by <span class="glossary-term" data-term="imperative">imperative<span class="glossary-popup">Imperative programs are a sequence of statements that change a program’s state.  This is probably the dominant paradigm for programming languages today.  Languages from Assembly to Python are built around this concept and most modern languages still allow you to program in this style.
</span></span> code blocks.</p>

<h1 id="using-observable">Using Observable</h1>

<p><span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> (we’ll use the implementation from RxJS) wraps common <span class="glossary-term" data-term="asynchronous">asynchronous<span class="glossary-popup">Operations that occur independently of the main program flow, allowing the program to continue executing while waiting for the operation to complete.
</span></span> actions like user events and intervals in streams, that we can process with a chain of “operators” applied to the chain through a <code class="language-plaintext highlighter-rouge">pipe</code>.</p>

<p>We start more or less the same as before, inside a function applied on <code class="language-plaintext highlighter-rouge">window.onload</code>, and we still need local variables for the ship visual and its position/angle:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span>
    <span class="nx">ship</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">ship</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">,</span>
    <span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="na">angle</span><span class="p">:</span><span class="mi">0</span> <span class="p">};</span>
<span class="p">...</span>
</code></pre></div></div>

<p>But now we use the RxJS <code class="language-plaintext highlighter-rouge">fromEvent</code> function to create an <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> <code class="language-plaintext highlighter-rouge">keydown$</code> (the “$” is a convention indicating the variable is a stream),</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">keydown$</span> <span class="o">=</span> <span class="nx">fromEvent</span><span class="o">&lt;</span><span class="nx">KeyboardEvent</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<p>The objects coming through the stream are of type <code class="language-plaintext highlighter-rouge">KeyboardEvent</code>, meaning they have the <code class="language-plaintext highlighter-rouge">key</code> and <code class="language-plaintext highlighter-rouge">repeat</code> properties we used before.  We can create a new stream that filters these out:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">arrowKeys$</span> <span class="o">=</span> <span class="nx">keydown$</span><span class="p">.</span><span class="nf">pipe</span><span class="p">(</span>
    <span class="nf">filter</span><span class="p">(({</span><span class="nx">key</span><span class="p">})</span><span class="o">=&gt;</span><span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ArrowLeft</span><span class="dl">'</span> <span class="o">||</span> <span class="nx">key</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ArrowRight</span><span class="dl">'</span><span class="p">),</span>
    <span class="nf">filter</span><span class="p">(({</span><span class="nx">repeat</span><span class="p">})</span><span class="o">=&gt;!</span><span class="nx">repeat</span><span class="p">));</span>
</code></pre></div></div>

<p>To duplicate the behaviour of our event-driven version we need to rotate every 10ms.  We can make a stream that fires every 10ms using <code class="language-plaintext highlighter-rouge">interval(10)</code>, which we can “graft” onto our <code class="language-plaintext highlighter-rouge">arrowKeys$</code> stream using <code class="language-plaintext highlighter-rouge">mergeMap</code>.  We use <code class="language-plaintext highlighter-rouge">takeUntil</code> to terminate the interval on a <code class="language-plaintext highlighter-rouge">'keyup'</code>, filtered to ignore keys other than the one that initiated the <code class="language-plaintext highlighter-rouge">'keydown'</code>.  At the end of the <code class="language-plaintext highlighter-rouge">mergeMap</code> <code class="language-plaintext highlighter-rouge">pipe</code> we use <code class="language-plaintext highlighter-rouge">map</code> to return <code class="language-plaintext highlighter-rouge">d</code>, the original keydown <code class="language-plaintext highlighter-rouge">KeyboardEvent</code> object.  Back at the top-level <code class="language-plaintext highlighter-rouge">pipe</code> on arrowKeys$ we inspect this <code class="language-plaintext highlighter-rouge">KeyboardEvent</code> object to see whether we need a left or right rotation (positive or negative angle).  Thus, <code class="language-plaintext highlighter-rouge">angle$</code> is just a stream of <code class="language-plaintext highlighter-rouge">-1</code> and <code class="language-plaintext highlighter-rouge">1</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">angle$</span> <span class="o">=</span> <span class="nx">arrowKeys$</span><span class="p">.</span><span class="nf">pipe</span><span class="p">(</span>
    <span class="nf">mergeMap</span><span class="p">(</span><span class="nx">d</span><span class="o">=&gt;</span><span class="nf">interval</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">pipe</span><span class="p">(</span>
      <span class="nf">takeUntil</span><span class="p">(</span><span class="nx">fromEvent</span><span class="o">&lt;</span><span class="nx">KeyboardEvent</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span><span class="p">).</span><span class="nf">pipe</span><span class="p">(</span>
        <span class="nf">filter</span><span class="p">(({</span><span class="nx">key</span><span class="p">})</span><span class="o">=&gt;</span><span class="nx">key</span> <span class="o">===</span> <span class="nx">d</span><span class="p">.</span><span class="nx">key</span><span class="p">)</span>
      <span class="p">)),</span>
      <span class="nf">map</span><span class="p">(</span><span class="nx">_</span><span class="o">=&gt;</span><span class="nx">d</span><span class="p">))</span>
    <span class="p">),</span>
    <span class="nf">map</span><span class="p">(</span><span class="nx">d</span><span class="o">=&gt;</span><span class="nx">d</span><span class="p">.</span><span class="nx">key</span><span class="o">===</span><span class="dl">'</span><span class="s1">ArrowLeft</span><span class="dl">'</span><span class="p">?</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">));</span>
</code></pre></div></div>

<p>Finally, we <code class="language-plaintext highlighter-rouge">subscribe</code> to the <code class="language-plaintext highlighter-rouge">angle$</code> stream to perform our effectful code, updating <code class="language-plaintext highlighter-rouge">state</code> and rotating <code class="language-plaintext highlighter-rouge">ship</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">angle$</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nx">a</span><span class="o">=&gt;</span>
      <span class="nx">ship</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">transform</span><span class="dl">'</span><span class="p">,</span>
       <span class="s2">`translate(</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">,</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">) rotate(</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">angle</span><span class="o">+=</span><span class="nx">a</span><span class="p">}</span><span class="s2">)`</span><span class="p">)</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Arguably, the <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> code has many advantages over the event handling code:</p>

<ul>
  <li>The streams created by <code class="language-plaintext highlighter-rouge">fromEvent</code> and <code class="language-plaintext highlighter-rouge">interval</code> automatically clean up the underlying events and interval handles when the streams complete.</li>
  <li>The “stream” abstraction provided by <span class="glossary-term" data-term="observable">observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> gives us an intuitive way to think about <span class="glossary-term" data-term="asynchronous">asynchronous<span class="glossary-popup">Operations that occur independently of the main program flow, allowing the program to continue executing while waiting for the operation to complete.
</span></span> behaviour and chain transformations of the stream together through <code class="language-plaintext highlighter-rouge">pipe</code>s.</li>
  <li>We didn’t see it so much here, but the various <span class="glossary-term" data-term="observable">observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> streams we created are composable, in the sense that adding new pipes (or potentially multiple <code class="language-plaintext highlighter-rouge">subscribe</code>s) to them allows us to reuse and plug them together in powerful ways.</li>
</ul>

<h2 id="pure-observable-streams">Pure Observable Streams</h2>

<p>A weakness of the above implementation using <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> streams is that we still have global mutable state.  Deep in the function passed to subscribe, we alter the angle attribute on the <code class="language-plaintext highlighter-rouge">state</code> object.  Another <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> operator <code class="language-plaintext highlighter-rouge">scan</code> allows us to capture this state transformation inside the stream, using a <span class="glossary-term" data-term="pure function">pure function<span class="glossary-popup">A function that always produces the same output for the same input and has no side effects.
</span></span> to transform the state, i.e. a function that takes an input state object and—rather than altering it in-place—creates a new output state object with whatever change is required.</p>

<p>We’ll start by altering the start of our code to define an <code class="language-plaintext highlighter-rouge">interface</code> for <code class="language-plaintext highlighter-rouge">State</code> with <code class="language-plaintext highlighter-rouge">readonly</code> members, and we’ll place our <code class="language-plaintext highlighter-rouge">initialState</code> in a <code class="language-plaintext highlighter-rouge">const</code> variable that matches this <span class="glossary-term" data-term="interface">interface<span class="glossary-popup">A TypeScript construct that defines the shape of an object, specifying the types of its properties and methods.
</span></span>.  You can also <a href="https://stackblitz.com/edit/asteroids02">play with the code in a live editor</a>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">type</span> <span class="nx">State</span> <span class="o">=</span> <span class="nb">Readonly</span><span class="o">&lt;</span><span class="p">{</span>
    <span class="na">x</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="nl">y</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="nl">angle</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
  <span class="p">}</span><span class="o">&gt;</span>
  <span class="kd">const</span> <span class="nx">initialState</span><span class="p">:</span> <span class="nx">State</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="na">angle</span><span class="p">:</span> <span class="mi">0</span><span class="p">};</span>
</code></pre></div></div>

<p>Now we’ll create a function that is a pure transformation of <code class="language-plaintext highlighter-rouge">State</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="kd">function</span> <span class="nf">rotate</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="nx">State</span><span class="p">,</span> <span class="nx">angleDelta</span><span class="p">:</span><span class="kr">number</span><span class="p">):</span> <span class="nx">State</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span> <span class="p">...</span><span class="nx">s</span><span class="p">,</span> <span class="c1">// copies the members of the input state for all but:</span>
      <span class="na">angle</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+</span> <span class="nx">angleDelta</span>  <span class="c1">// only the angle is different in the new State</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<p>Next, we have another, completely self-contained function to update the <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span> for a given state:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="kd">function</span> <span class="nf">updateView</span><span class="p">(</span><span class="nx">state</span><span class="p">:</span><span class="nx">State</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">ship</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">ship</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
    <span class="nx">ship</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">transform</span><span class="dl">'</span><span class="p">,</span>
     <span class="s2">`translate(</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">,</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">) rotate(</span><span class="p">${</span><span class="nx">state</span><span class="p">.</span><span class="nx">angle</span><span class="p">}</span><span class="s2">)`</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">...</span>
</code></pre></div></div>

<p>And now our main <code class="language-plaintext highlighter-rouge">pipe</code> (collapsed into one) ends with a <code class="language-plaintext highlighter-rouge">scan</code> which “transduces” (transforms and reduces) our state, and the <code class="language-plaintext highlighter-rouge">subscribe</code> is a trivial call to <code class="language-plaintext highlighter-rouge">updateView</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="nx">fromEvent</span><span class="o">&lt;</span><span class="nx">KeyboardEvent</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span>
      <span class="nf">filter</span><span class="p">(({</span><span class="nx">code</span><span class="p">})</span><span class="o">=&gt;</span><span class="nx">code</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ArrowLeft</span><span class="dl">'</span> <span class="o">||</span> <span class="nx">code</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">ArrowRight</span><span class="dl">'</span><span class="p">),</span>
      <span class="nf">filter</span><span class="p">(({</span><span class="nx">repeat</span><span class="p">})</span><span class="o">=&gt;!</span><span class="nx">repeat</span><span class="p">),</span>
      <span class="nf">mergeMap</span><span class="p">(</span><span class="nx">d</span><span class="o">=&gt;</span><span class="nf">interval</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">pipe</span><span class="p">(</span>
        <span class="nf">takeUntil</span><span class="p">(</span><span class="nx">fromEvent</span><span class="o">&lt;</span><span class="nx">KeyboardEvent</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span><span class="p">).</span><span class="nf">pipe</span><span class="p">(</span>
          <span class="nf">filter</span><span class="p">(({</span><span class="nx">code</span><span class="p">})</span><span class="o">=&gt;</span><span class="nx">code</span> <span class="o">===</span> <span class="nx">d</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span>
        <span class="p">)),</span>
        <span class="nf">map</span><span class="p">(</span><span class="nx">_</span><span class="o">=&gt;</span><span class="nx">d</span><span class="p">))</span>
      <span class="p">),</span>
      <span class="nf">map</span><span class="p">(({</span><span class="nx">code</span><span class="p">})</span><span class="o">=&gt;</span><span class="nx">code</span><span class="o">===</span><span class="dl">'</span><span class="s1">ArrowLeft</span><span class="dl">'</span><span class="p">?</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">),</span>
      <span class="nf">scan</span><span class="p">(</span><span class="nx">rotate</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nx">updateView</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The code above is a bit longer than what we started with, but it’s starting to lay a more extensible framework for a more complete game.  And it has some nice architectural properties, in particular we’ve completely decoupled our view code from our state management.  We could swap out <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span> for a completely different UI by replacing the <code class="language-plaintext highlighter-rouge">updateView</code> function.</p>

<h2 id="adding-physics-and-handling-more-inputs">Adding Physics and Handling More Inputs</h2>

<p>Classic Asteroids is more of a space flight simulator in a weird toroidal topology than the “static” rotation that we’ve provided above.  We will make our spaceship a freely floating body in space, with directional and rotational velocity.
We are going to need more inputs than just left and right arrow keys to pilot our ship too.</p>

<p>Here’s a sneak preview of what this next stage will look like (click on the image to try it out in a live code editor):</p>

<p><a href="https://stackblitz.com/edit/asteroids03?file=index.ts"><img src="/assets/images/chapterImages/asteroids/asteroidsFly.gif" alt="Spaceship flying"></a></p>

<h1 id="input-actions">Input Actions</h1>

<p>Let’s start with adding “thrust” in response to up arrow.
With the code above, adding more and more intervals triggered by key down events would get increasingly messy.
Rather than have streams triggered by key events, for the purposes of simulation it makes sense that our main <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> be a stream of discrete timesteps.  Thus, we’ll be moving our <code class="language-plaintext highlighter-rouge">interval(10)</code> to the top of our pipe.</p>

<p>Before, we had just left and right rotations coming out of our stream.  Our new stream is going to have multiple types of actions as payload:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Tick</code> - a discrete timestep in our simulation, triggered by <code class="language-plaintext highlighter-rouge">interval</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">Rotate</code> - a ship rotation triggered by left or right arrows keys</li>
  <li><code class="language-plaintext highlighter-rouge">Thrust</code> - fire the boosters! Using the up-arrow key</li>
</ul>

<p>We’ll create separate <span class="glossary-term" data-term="observables">Observables<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> for each of the key events.  There’s a repetitive pattern in creating each of these <span class="glossary-term" data-term="observables">Observables<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span>, for a given:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Event</code> - keydown or keyup</li>
  <li><code class="language-plaintext highlighter-rouge">Key</code> - one of the arrows (for now)</li>
  <li>produce an <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> stream of a particular action type.</li>
</ul>

<p>It sounds like something we can model with a nice reusable function:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">type</span> <span class="nx">Event</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span>
  <span class="kd">type</span> <span class="nx">Key</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">ArrowLeft</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">ArrowRight</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">ArrowUp</span><span class="dl">'</span>
  <span class="kd">const</span> <span class="nx">observeKey</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">eventName</span><span class="p">:</span><span class="nx">Event</span><span class="p">,</span> <span class="nx">k</span><span class="p">:</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">result</span><span class="p">:()</span><span class="o">=&gt;</span><span class="nx">T</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="nx">fromEvent</span><span class="o">&lt;</span><span class="nx">KeyboardEvent</span><span class="o">&gt;</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span><span class="nx">eventName</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span>
        <span class="nf">filter</span><span class="p">(({</span><span class="nx">code</span><span class="p">})</span><span class="o">=&gt;</span><span class="nx">code</span> <span class="o">===</span> <span class="nx">k</span><span class="p">),</span>
        <span class="nf">filter</span><span class="p">(({</span><span class="nx">repeat</span><span class="p">})</span><span class="o">=&gt;!</span><span class="nx">repeat</span><span class="p">),</span>
        <span class="nf">map</span><span class="p">(</span><span class="nx">result</span><span class="p">)),</span>
</code></pre></div></div>

<p>Now we have all the pieces to create a whole slew of input streams (the definitions for <code class="language-plaintext highlighter-rouge">Rotate</code> and <code class="language-plaintext highlighter-rouge">Thrust</code> classes are <a href="#reducing-state">below</a>):</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span>
    <span class="nx">startLeftRotate</span> <span class="o">=</span> <span class="nf">observeKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ArrowLeft</span><span class="dl">'</span><span class="p">,()</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Rotate</span><span class="p">(</span><span class="o">-</span><span class="p">.</span><span class="mi">1</span><span class="p">)),</span>
    <span class="nx">startRightRotate</span> <span class="o">=</span> <span class="nf">observeKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ArrowRight</span><span class="dl">'</span><span class="p">,()</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Rotate</span><span class="p">(.</span><span class="mi">1</span><span class="p">)),</span>
    <span class="nx">stopLeftRotate</span> <span class="o">=</span> <span class="nf">observeKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ArrowLeft</span><span class="dl">'</span><span class="p">,()</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Rotate</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
    <span class="nx">stopRightRotate</span> <span class="o">=</span> <span class="nf">observeKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ArrowRight</span><span class="dl">'</span><span class="p">,()</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Rotate</span><span class="p">(</span><span class="mi">0</span><span class="p">)),</span>
    <span class="nx">startThrust</span> <span class="o">=</span> <span class="nf">observeKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ArrowUp</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Thrust</span><span class="p">(</span><span class="kc">true</span><span class="p">)),</span>
    <span class="nx">stopThrust</span> <span class="o">=</span> <span class="nf">observeKey</span><span class="p">(</span><span class="dl">'</span><span class="s1">keyup</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">ArrowUp</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Thrust</span><span class="p">(</span><span class="kc">false</span><span class="p">))</span>
</code></pre></div></div>

<h1 id="vector-maths">Vector Maths</h1>

<p>Since we’re going to start worrying about the physics of our simulation, we’re going to need some helper code. First, a handy dandy Vector class.  It’s just standard vector maths, so hopefully self-explanatory.  In the spirit of being pure and <span class="glossary-term" data-term="declarative">declarative<span class="glossary-popup">Declarative languages focus on declaring <em>what</em> a procedure (or function) should do rather than <em>how</em> it should do it.
</span></span> I’ve made it immutable, and all the functions (except <code class="language-plaintext highlighter-rouge">len</code> which returns a number) return new instances of <code class="language-plaintext highlighter-rouge">Vec</code> rather than changing its data in place.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Vec</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="k">public</span> <span class="k">readonly</span> <span class="nx">x</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="k">public</span> <span class="k">readonly</span> <span class="nx">y</span><span class="p">:</span> <span class="kr">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span><span class="p">:</span><span class="nx">Vec</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="nx">sub</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span><span class="p">:</span><span class="nx">Vec</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
  <span class="nx">len</span> <span class="o">=</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span>
  <span class="nx">scale</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="o">*</span><span class="nx">s</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="o">*</span><span class="nx">s</span><span class="p">)</span>
  <span class="nx">ortho</span> <span class="o">=</span> <span class="p">()</span><span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="o">-</span><span class="k">this</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span>
  <span class="nx">rotate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">deg</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="p">(</span><span class="nx">rad</span> <span class="o">=&gt;</span><span class="p">(</span>
                <span class="p">(</span><span class="nx">cos</span><span class="p">,</span><span class="nx">sin</span><span class="p">,{</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">})</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="nx">x</span><span class="o">*</span><span class="nx">cos</span> <span class="o">-</span> <span class="nx">y</span><span class="o">*</span><span class="nx">sin</span><span class="p">,</span> <span class="nx">x</span><span class="o">*</span><span class="nx">sin</span> <span class="o">+</span> <span class="nx">y</span><span class="o">*</span><span class="nx">cos</span><span class="p">)</span>
              <span class="p">)(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="nx">rad</span><span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="nx">rad</span><span class="p">),</span> <span class="k">this</span><span class="p">)</span>
            <span class="p">)(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">deg</span> <span class="o">/</span> <span class="mi">180</span><span class="p">)</span>

  <span class="k">static</span> <span class="nx">unitVecInDirection</span> <span class="o">=</span> <span class="p">(</span><span class="nx">deg</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nf">rotate</span><span class="p">(</span><span class="nx">deg</span><span class="p">)</span>
  <span class="k">static</span> <span class="nx">Zero</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To implement the toroidal topology of space, we’ll need to know the canvas size.
For now, we’ll hard-code it in a constant <code class="language-plaintext highlighter-rouge">CanvasSize</code>.  Alternately, we could query it from the <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span> element, or we could set the <span class="glossary-term" data-term="svg">SVG<span class="glossary-popup">Scalable Vector Graphics - another part of the HTML standard for specifying images declaratively as sets of shapes and paths.
</span></span> size—maybe later.
The torus wrapping function will use the <code class="language-plaintext highlighter-rouge">CanvasSize</code> to determine the bounds and simply teleport any <code class="language-plaintext highlighter-rouge">Vec</code> which goes out of bounds to the opposite side.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span>
  <span class="nx">CanvasSize</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
  <span class="nx">torusWrap</span> <span class="o">=</span> <span class="p">({</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">}:</span><span class="nx">Vec</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">wrap</span> <span class="o">=</span> <span class="p">(</span><span class="na">v</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">v</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">?</span> <span class="nx">v</span> <span class="o">+</span> <span class="nx">CanvasSize</span> <span class="p">:</span> <span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">CanvasSize</span> <span class="p">?</span> <span class="nx">v</span> <span class="o">-</span> <span class="nx">CanvasSize</span> <span class="p">:</span> <span class="nx">v</span><span class="p">;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="nf">wrap</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span><span class="nf">wrap</span><span class="p">(</span><span class="nx">y</span><span class="p">))</span>
  <span class="p">};</span>
</code></pre></div></div>

<p>We’ll use <code class="language-plaintext highlighter-rouge">Vec</code> in a slightly richer set of State.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">type</span> <span class="nx">State</span> <span class="o">=</span> <span class="nb">Readonly</span><span class="o">&lt;</span><span class="p">{</span>
    <span class="na">pos</span><span class="p">:</span><span class="nx">Vec</span><span class="p">,</span>
    <span class="na">vel</span><span class="p">:</span><span class="nx">Vec</span><span class="p">,</span>
    <span class="na">acc</span><span class="p">:</span><span class="nx">Vec</span><span class="p">,</span>
    <span class="na">angle</span><span class="p">:</span><span class="kr">number</span><span class="p">,</span>
    <span class="na">rotation</span><span class="p">:</span><span class="kr">number</span><span class="p">,</span>
    <span class="na">torque</span><span class="p">:</span><span class="kr">number</span>
  <span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>We create an <code class="language-plaintext highlighter-rouge">initialState</code> using <code class="language-plaintext highlighter-rouge">CanvasSize</code> to start the spaceship at the centre:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">initialState</span><span class="p">:</span><span class="nx">State</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">pos</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="nx">CanvasSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="nx">CanvasSize</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
      <span class="na">vel</span><span class="p">:</span> <span class="nx">Vec</span><span class="p">.</span><span class="nx">Zero</span><span class="p">,</span>
      <span class="na">acc</span><span class="p">:</span> <span class="nx">Vec</span><span class="p">.</span><span class="nx">Zero</span><span class="p">,</span>
      <span class="na">angle</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">rotation</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">torque</span><span class="p">:</span><span class="mi">0</span>
  <span class="p">}</span>
</code></pre></div></div>

<h1 id="reducing-state">Reducing State</h1>

<p>Now we are ready to define the actions that are triggered by the key events.  Each action modifies state in some way.  Let’s define a common type for actions with a single pure method that takes a previous state, and returns a new state after applying the action.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nf">apply</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span> <span class="nx">State</span><span class="p">):</span> <span class="nx">State</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we define a class implementing <code class="language-plaintext highlighter-rouge">Action</code> for each of <code class="language-plaintext highlighter-rouge">Tick</code>, <code class="language-plaintext highlighter-rouge">Rotate</code>, and <code class="language-plaintext highlighter-rouge">Thrust</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Tick</span> <span class="k">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="k">public</span> <span class="k">readonly</span> <span class="nx">elapsed</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nf">apply</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="nx">State</span><span class="p">):</span><span class="nx">State</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{...</span><span class="nx">s</span><span class="p">,</span>
      <span class="na">rotation</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">rotation</span><span class="o">+</span><span class="nx">s</span><span class="p">.</span><span class="nx">torque</span><span class="p">,</span>
      <span class="na">angle</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">angle</span><span class="o">+</span><span class="nx">s</span><span class="p">.</span><span class="nx">rotation</span><span class="p">,</span>
      <span class="na">pos</span><span class="p">:</span> <span class="nf">torusWrap</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">vel</span><span class="p">)),</span>
      <span class="na">vel</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">acc</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">Rotate</span> <span class="k">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="k">public</span> <span class="k">readonly</span> <span class="nx">direction</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nf">apply</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="nx">State</span><span class="p">):</span><span class="nx">State</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{...</span><span class="nx">s</span><span class="p">,</span>
      <span class="na">torque</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">direction</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="nc">Thrust</span> <span class="k">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="k">public</span> <span class="k">readonly</span> <span class="nx">on</span><span class="p">:</span><span class="nx">boolean</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nf">apply</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="nx">State</span><span class="p">):</span><span class="nx">State</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{...</span><span class="nx">s</span><span class="p">,</span>
        <span class="na">acc</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">on</span> <span class="p">?</span> <span class="nx">Vec</span><span class="p">.</span><span class="nf">unitVecInDirection</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">angle</span><span class="p">).</span><span class="nf">scale</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
                 <span class="p">:</span> <span class="nx">Vec</span><span class="p">.</span><span class="nx">Zero</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And now our function to reduce state is very simple, taking advantage of subtype polymorphism to apply the correct update to <code class="language-plaintext highlighter-rouge">State</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">reduceState</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">:</span> <span class="nx">State</span><span class="p">,</span> <span class="nx">action</span><span class="p">:</span> <span class="nx">Action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">action</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
</code></pre></div></div>

<p>And finally we <code class="language-plaintext highlighter-rouge">merge</code> our different inputs and scan over <code class="language-plaintext highlighter-rouge">State</code>, and the final <code class="language-plaintext highlighter-rouge">subscribe</code> calls the <code class="language-plaintext highlighter-rouge">updateView</code>, once again, a self-contained function which does whatever is required to render the State.  We describe the updated <code class="language-plaintext highlighter-rouge">updateView</code> in the next section.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nf">merge</span><span class="p">(</span>
    <span class="nf">interval</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">pipe</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nx">elapsed</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Tick</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">))),</span>
    <span class="nx">startLeftRotate</span><span class="p">,</span> <span class="nx">startRightRotate</span><span class="p">,</span> <span class="nx">stopLeftRotate</span><span class="p">,</span> <span class="nx">stopRightRotate</span><span class="p">,</span>
    <span class="nx">startThrust</span><span class="p">,</span> <span class="nx">stopThrust</span><span class="p">,</span>
  <span class="p">)</span>
    <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span><span class="nf">scan</span><span class="p">(</span><span class="nx">reduceState</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nx">updateView</span><span class="p">);</span>
</code></pre></div></div>

<h1 id="view">View</h1>

<p>Once again, the above completely decouples the view from state management.  But now we have a richer state, we have more stuff we can show in the view.  We’ll start with a little <span class="glossary-term" data-term="css">CSS<span class="glossary-popup">Cascading Style Sheets - another declarative (part of the HTML5 standard) for specifying reusable styles for web page rendering.
</span></span>, not only to style elements, but also to hide or show flame from our boosters.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.ship</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nx">lightblue</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.booster</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nx">orange</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.hidden</span> <span class="p">{</span>
  <span class="nl">visibility</span><span class="p">:</span><span class="nb">hidden</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We add a few more polygons for the booster flames:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/bundle.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;svg</span> <span class="na">id=</span><span class="s">"svgCanvas"</span> <span class="na">width=</span><span class="s">"200"</span> <span class="na">height=</span><span class="s">"200"</span> <span class="na">style=</span><span class="s">"background-color:black"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;g</span> <span class="na">id=</span><span class="s">"ship"</span> <span class="na">transform=</span><span class="s">"translate(100,100)"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;polygon</span> <span class="na">class=</span><span class="s">"booster hidden"</span> <span class="na">id=</span><span class="s">"forwardThrust"</span> <span class="na">points=</span><span class="s">"-3,20 0,35 3,20"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/polygon&gt;</span>
    <span class="nt">&lt;polygon</span> <span class="na">class=</span><span class="s">"booster hidden"</span> <span class="na">id=</span><span class="s">"leftThrust"</span> <span class="na">points=</span><span class="s">"2,-10 15,-12 2,-14"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/polygon&gt;</span>
    <span class="nt">&lt;polygon</span> <span class="na">class=</span><span class="s">"booster hidden"</span> <span class="na">id=</span><span class="s">"rightThrust"</span> <span class="na">points=</span><span class="s">"-2,-10 -15,-12 -2,-14"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/polygon&gt;</span>
    <span class="nt">&lt;polygon</span> <span class="na">class=</span><span class="s">"ship"</span> <span class="na">points=</span><span class="s">"-15,20 15,20 0,-20"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/polygon&gt;</span>
  <span class="nt">&lt;/g&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></div></div>

<p>And here’s our updated updateView function where we not only move the ship but also show flames shooting out of it as it powers around the torus:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">function</span> <span class="nf">updateView</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span> <span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span>
      <span class="nx">ship</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">ship</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">,</span>
      <span class="nx">show</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">:</span><span class="kr">string</span><span class="p">,</span><span class="nx">condition</span><span class="p">:</span><span class="nx">boolean</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">((</span><span class="nx">e</span><span class="p">:</span><span class="nx">HTMLElement</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">condition</span> <span class="p">?</span> <span class="nx">e</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="dl">'</span><span class="s1">hidden</span><span class="dl">'</span><span class="p">)</span>
                  <span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">'</span><span class="s1">hidden</span><span class="dl">'</span><span class="p">))(</span><span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span><span class="o">!</span><span class="p">);</span>
    <span class="nf">show</span><span class="p">(</span><span class="dl">"</span><span class="s2">leftThrust</span><span class="dl">"</span><span class="p">,</span>  <span class="nx">s</span><span class="p">.</span><span class="nx">torque</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">);</span>
    <span class="nf">show</span><span class="p">(</span><span class="dl">"</span><span class="s2">rightThrust</span><span class="dl">"</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">torque</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">);</span>
    <span class="nf">show</span><span class="p">(</span><span class="dl">"</span><span class="s2">forwardThrust</span><span class="dl">"</span><span class="p">,</span>    <span class="nx">s</span><span class="p">.</span><span class="nx">acc</span><span class="p">.</span><span class="nf">len</span><span class="p">()</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">ship</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">'</span><span class="s1">transform</span><span class="dl">'</span><span class="p">,</span> <span class="s2">`translate(</span><span class="p">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">}</span><span class="s2">,</span><span class="p">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span><span class="s2">) rotate(</span><span class="p">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">angle</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></div>

<h2 id="additional-objects">Additional Objects</h2>

<p>Things get more complicated when we start adding more objects to the canvas that all participate in the physics simulation.  Furthermore, objects like asteroids and bullets will need to be added and removed from the canvas dynamically—unlike the ship whose visual is currently defined in the <code class="language-plaintext highlighter-rouge">svg</code> and never leaves.</p>

<p>However, we now have all the pieces of our MVC architecture in place, all tied together with an <span class="glossary-term" data-term="observable">observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> stream:</p>

<p><img src="/assets/images/chapterImages/asteroids/MVC.png" alt="Observable MVC Architecture"></p>

<p>So completing the game is just a matter of:</p>

<ul>
  <li>adding more input actions (e.g. <code class="language-plaintext highlighter-rouge">Shoot</code>)</li>
  <li>extending our state data structure to include bullets, rocks, etc.</li>
  <li>extending our reduce state function to manipulate this State</li>
  <li>extending the <code class="language-plaintext highlighter-rouge">updateView</code> function so the user can see it</li>
</ul>

<p>We’ll start with bullets that can be fired with the Space key, and which expire after a set period of time:</p>

<p><a href="https://stackblitz.com/edit/asteroids04?file=index.ts"><img src="/assets/images/chapterImages/asteroids/asteroidsShoot.gif" alt="Spaceship flying"></a></p>

<h1 id="per-object-state">Per-object State</h1>

<p>The first complication is generalising bodies that participate in the force model with their own type <code class="language-plaintext highlighter-rouge">Body</code>, separate from the <code class="language-plaintext highlighter-rouge">State</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">type</span> <span class="nx">Body</span> <span class="o">=</span> <span class="nb">Readonly</span><span class="o">&lt;</span><span class="p">{</span>
    <span class="na">id</span><span class="p">:</span><span class="kr">string</span><span class="p">,</span>
    <span class="na">pos</span><span class="p">:</span><span class="nx">Vec</span><span class="p">,</span>
    <span class="na">vel</span><span class="p">:</span><span class="nx">Vec</span><span class="p">,</span>
    <span class="na">thrust</span><span class="p">:</span><span class="nx">boolean</span><span class="p">,</span>
    <span class="na">angle</span><span class="p">:</span><span class="kr">number</span><span class="p">,</span>
    <span class="na">rotation</span><span class="p">:</span><span class="kr">number</span><span class="p">,</span>
    <span class="na">torque</span><span class="p">:</span><span class="kr">number</span><span class="p">,</span>
    <span class="na">radius</span><span class="p">:</span><span class="kr">number</span><span class="p">,</span>
    <span class="na">createTime</span><span class="p">:</span><span class="kr">number</span>
  <span class="p">}</span><span class="o">&gt;</span>
  <span class="kd">type</span> <span class="nx">State</span> <span class="o">=</span> <span class="nb">Readonly</span><span class="o">&lt;</span><span class="p">{</span>
    <span class="na">time</span><span class="p">:</span><span class="kr">number</span><span class="p">,</span>
    <span class="na">ship</span><span class="p">:</span><span class="nx">Body</span><span class="p">,</span>
    <span class="na">bullets</span><span class="p">:</span><span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="na">exit</span><span class="p">:</span><span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="na">objCount</span><span class="p">:</span><span class="kr">number</span>
  <span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>So the <code class="language-plaintext highlighter-rouge">ship</code> is a <code class="language-plaintext highlighter-rouge">Body</code>, and we will have collections of <code class="language-plaintext highlighter-rouge">Body</code> for both <code class="language-plaintext highlighter-rouge">bullets</code> and <code class="language-plaintext highlighter-rouge">rocks</code>.  What’s this <code class="language-plaintext highlighter-rouge">exit</code> thing?  Well, when we remove something from the canvas, e.g. a bullet, we’ll create a new state with a copy of the <code class="language-plaintext highlighter-rouge">bullets</code> array minus the removed bullet, and we’ll add that removed bullet—together with any other removed <code class="language-plaintext highlighter-rouge">Body</code>s—to the <code class="language-plaintext highlighter-rouge">exit</code> array.  This notifies the <code class="language-plaintext highlighter-rouge">updateView</code> function that they can be removed.</p>

<p>Note the <code class="language-plaintext highlighter-rouge">objCount</code>.  This counter is incremented every time we add a <code class="language-plaintext highlighter-rouge">Body</code> and gives us a way to create a unique id that can be used to match the <code class="language-plaintext highlighter-rouge">Body</code> against its corresponding view object.</p>

<p>Now we define functions to create objects:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">function</span> <span class="nf">createBullet</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="nx">State</span><span class="p">):</span><span class="nx">Body</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">Vec</span><span class="p">.</span><span class="nf">unitVecInDirection</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ship</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="s2">`bullet</span><span class="p">${</span><span class="nx">s</span><span class="p">.</span><span class="nx">objCount</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
      <span class="na">pos</span><span class="p">:</span><span class="nx">s</span><span class="p">.</span><span class="nx">ship</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ship</span><span class="p">.</span><span class="nx">radius</span><span class="p">)),</span>
      <span class="na">vel</span><span class="p">:</span><span class="nx">s</span><span class="p">.</span><span class="nx">ship</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">scale</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span>
      <span class="na">createTime</span><span class="p">:</span><span class="nx">s</span><span class="p">.</span><span class="nx">time</span><span class="p">,</span>
      <span class="na">thrust</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
      <span class="na">angle</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">rotation</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">torque</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">radius</span><span class="p">:</span><span class="mi">3</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">function</span> <span class="nf">createShip</span><span class="p">():</span><span class="nx">Body</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">ship</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">pos</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="nx">CanvasSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="nx">CanvasSize</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
      <span class="na">vel</span><span class="p">:</span> <span class="nx">Vec</span><span class="p">.</span><span class="nx">Zero</span><span class="p">,</span>
      <span class="na">thrust</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span>
      <span class="na">angle</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">rotation</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">torque</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">radius</span><span class="p">:</span><span class="mi">20</span><span class="p">,</span>
      <span class="na">createTime</span><span class="p">:</span><span class="mi">0</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">initialState</span><span class="p">:</span><span class="nx">State</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">time</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
    <span class="na">ship</span><span class="p">:</span> <span class="nf">createShip</span><span class="p">(),</span>
    <span class="na">bullets</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">exit</span><span class="p">:</span> <span class="p">[],</span>
    <span class="na">objCount</span><span class="p">:</span> <span class="mi">0</span>
  <span class="p">}</span>
</code></pre></div></div>

<h1 id="shoot-action">Shoot Action</h1>

<p>We’ll add a new action type and <span class="glossary-term" data-term="observable">observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> for shooting with the space bar:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Shoot</span> <span class="k">implements</span> <span class="nx">Action</span> <span class="p">{</span>
    <span class="cm">/**
     * a new bullet is created and added to the bullets array
     * @param s State
     * @returns new State
     */</span>
    <span class="nx">apply</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">:</span> <span class="nx">State</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="p">...</span><span class="nx">s</span><span class="p">,</span>
      <span class="na">bullets</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">bullets</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="nf">createBullet</span><span class="p">(</span><span class="nx">s</span><span class="p">)]),</span>
      <span class="na">objCount</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">objCount</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">})</span>
<span class="p">}</span>
<span class="kd">const</span> <span class="nx">shoot</span> <span class="o">=</span> <span class="nf">keyObservable</span><span class="p">(</span><span class="dl">'</span><span class="s1">keydown</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">Space</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Shoot</span><span class="p">())</span>
</code></pre></div></div>

<p>And now a function to move objects, same logic as before but now applicable to any <code class="language-plaintext highlighter-rouge">Body</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">moveObj</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span><span class="p">:</span><span class="nx">Body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="p">...</span><span class="nx">o</span><span class="p">,</span>
    <span class="na">rotation</span><span class="p">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">rotation</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">torque</span><span class="p">,</span>
    <span class="na">angle</span><span class="p">:</span><span class="nx">o</span><span class="p">.</span><span class="nx">angle</span><span class="o">+</span><span class="nx">o</span><span class="p">.</span><span class="nx">rotation</span><span class="p">,</span>
    <span class="na">pos</span><span class="p">:</span><span class="nf">torusWrap</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">vel</span><span class="p">)),</span>
    <span class="na">vel</span><span class="p">:</span><span class="nx">o</span><span class="p">.</span><span class="nx">thrust</span><span class="p">?</span><span class="nx">o</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="nx">Vec</span><span class="p">.</span><span class="nf">unitVecInDirection</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">angle</span><span class="p">).</span><span class="nf">scale</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)):</span><span class="nx">o</span><span class="p">.</span><span class="nx">vel</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>And our <code class="language-plaintext highlighter-rouge">Tick</code> action is a little more complicated now:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Tick</span> <span class="k">implements</span> <span class="nx">Action</span> <span class="p">{</span>
  <span class="nf">constructor</span><span class="p">(</span><span class="k">public</span> <span class="k">readonly</span> <span class="nx">elapsed</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span> <span class="p">{}</span>
  <span class="nf">apply</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="nx">State</span><span class="p">):</span><span class="nx">State</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">not</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">f</span><span class="p">:(</span><span class="nx">x</span><span class="p">:</span><span class="nx">T</span><span class="p">)</span><span class="o">=&gt;</span><span class="nx">boolean</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">(</span><span class="nx">x</span><span class="p">:</span><span class="nx">T</span><span class="p">)</span><span class="o">=&gt;!</span><span class="nf">f</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span>
      <span class="nx">expired</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span><span class="p">:</span><span class="nx">Body</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">elapsed</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">createTime</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">,</span>
      <span class="nx">expiredBullets</span><span class="p">:</span><span class="nx">Body</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">bullets</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">expired</span><span class="p">),</span>
      <span class="nx">activeBullets</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">bullets</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">not</span><span class="p">(</span><span class="nx">expired</span><span class="p">));</span>
    <span class="k">return</span> <span class="o">&lt;</span><span class="nx">State</span><span class="o">&gt;</span><span class="p">{...</span><span class="nx">s</span><span class="p">,</span>
      <span class="na">ship</span><span class="p">:</span><span class="nf">moveObj</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">ship</span><span class="p">),</span>
      <span class="na">bullets</span><span class="p">:</span><span class="nx">activeBullets</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">moveObj</span><span class="p">),</span>
      <span class="na">exit</span><span class="p">:</span><span class="nx">expiredBullets</span><span class="p">,</span>
      <span class="na">time</span><span class="p">:</span><span class="k">this</span><span class="p">.</span><span class="nx">elapsed</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that bullets have a lifetime (presumably they are energy balls that fizzle into space after a certain time).  When a bullet expires it is sent to <code class="language-plaintext highlighter-rouge">exit</code>.</p>

<p>We merge the Shoot stream in as before:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nf">merge</span><span class="p">(</span>
<span class="p">...</span>
    <span class="nx">shoot</span><span class="p">,</span>
<span class="p">...</span>
  <span class="p">)</span>
</code></pre></div></div>

<p>And we tack a bit onto <code class="language-plaintext highlighter-rouge">updateView</code> to draw and remove bullets:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">function</span> <span class="nf">updateView</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span> <span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>
    <span class="kd">const</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">svgCanvas</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">bullets</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">b</span><span class="o">=&gt;</span><span class="p">{</span>
      <span class="kd">const</span> <span class="nx">createBulletView</span> <span class="o">=</span> <span class="p">()</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="kd">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElementNS</span><span class="p">(</span><span class="nx">svg</span><span class="p">.</span><span class="nx">namespaceURI</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ellipse</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
        <span class="nx">v</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">,</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="nx">v</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">bullet</span><span class="dl">"</span><span class="p">)</span>
        <span class="nx">svg</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">v</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">||</span> <span class="nf">createBulletView</span><span class="p">();</span>
      <span class="nx">v</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">cx</span><span class="dl">"</span><span class="p">,</span><span class="nc">String</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">x</span><span class="p">))</span>
      <span class="nx">v</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">cy</span><span class="dl">"</span><span class="p">,</span><span class="nc">String</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span>
      <span class="nx">v</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">rx</span><span class="dl">"</span><span class="p">,</span> <span class="nc">String</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">radius</span><span class="p">));</span>
      <span class="nx">v</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="dl">"</span><span class="s2">ry</span><span class="dl">"</span><span class="p">,</span> <span class="nc">String</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">radius</span><span class="p">));</span>
    <span class="p">})</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">exit</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">o</span><span class="o">=&gt;</span><span class="p">{</span>
      <span class="kd">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="nx">svg</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
    <span class="p">})</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>Finally, we make a quick addition to the <span class="glossary-term" data-term="css">CSS<span class="glossary-popup">Cascading Style Sheets - another declarative (part of the HTML5 standard) for specifying reusable styles for web page rendering.
</span></span> so that the bullets are a different colour to the background:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.bullet</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nx">red</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="collisions">Collisions</h2>

<p>So far the game we have built allows you to hoon around in a spaceship blasting the void with fireballs which is kind of fun, but not very challenging.  The Asteroids game doesn’t really become “Asteroids” until you actually have… asteroids.  Also, you should be able to break them up with your blaster and crashing into them should end the game.  Here’s a preview:</p>

<p><a href="https://stackblitz.com/edit/asteroids05?file=index.ts"><img src="/assets/images/chapterImages/asteroids/asteroidsComplete.gif" alt="Spaceship flying"></a></p>

<p>Before we go forward, let’s put all the magic numbers that are starting to permeate our code in one, immutable place:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span>
    <span class="nx">Constants</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">CanvasSize</span><span class="p">:</span> <span class="mi">600</span><span class="p">,</span>
      <span class="na">BulletExpirationTime</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
      <span class="na">BulletRadius</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
      <span class="na">BulletVelocity</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
      <span class="na">StartRockRadius</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
      <span class="na">StartRocksCount</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="na">RotationAcc</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
      <span class="na">ThrustAcc</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
      <span class="na">StartTime</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span> <span class="kd">as const</span>
</code></pre></div></div>

<h1 id="initial-state">Initial State</h1>

<p>We will need to store two new pieces of state: the collection of asteroids (<code class="language-plaintext highlighter-rouge">rocks</code>) which is another array of <code class="language-plaintext highlighter-rouge">Body</code>, just like bullets; and also a boolean that will become <code class="language-plaintext highlighter-rouge">true</code> when the game ends due to collision between the ship and a rock.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">type</span> <span class="nx">State</span> <span class="o">=</span> <span class="nb">Readonly</span><span class="o">&lt;</span><span class="p">{</span>
    <span class="p">...</span>
    <span class="na">rocks</span><span class="p">:</span><span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="na">gameOver</span><span class="p">:</span><span class="nx">boolean</span>
  <span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Since bullets and rocks are both just circular <code class="language-plaintext highlighter-rouge">Body</code>s with constant velocity, we can generalise what was previously the <code class="language-plaintext highlighter-rouge">createBullet</code> function to create either:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">type</span> <span class="nx">ViewType</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">ship</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">rock</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">bullet</span><span class="dl">'</span>
  <span class="kd">const</span> <span class="nx">createCircle</span> <span class="o">=</span> <span class="p">(</span><span class="nx">viewType</span><span class="p">:</span> <span class="nx">ViewType</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">oid</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">time</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">radius</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">pos</span><span class="p">:</span><span class="nx">Vec</span><span class="p">)</span><span class="o">=&gt;</span> <span class="p">(</span><span class="nx">vel</span><span class="p">:</span><span class="nx">Vec</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span><span class="p">{</span>
      <span class="na">createTime</span><span class="p">:</span> <span class="nx">time</span><span class="p">,</span>
      <span class="na">pos</span><span class="p">:</span><span class="nx">pos</span><span class="p">,</span>
      <span class="na">vel</span><span class="p">:</span><span class="nx">vel</span><span class="p">,</span>
      <span class="na">thrust</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">angle</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="na">rotation</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="na">torque</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">radius</span><span class="p">:</span> <span class="nx">radius</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">viewType</span><span class="o">+</span><span class="nx">oid</span><span class="p">,</span>
      <span class="na">viewType</span><span class="p">:</span> <span class="nx">viewType</span>
    <span class="p">};</span>
</code></pre></div></div>

<p>Our initial state is going to include several rocks drifting in random directions, as follows:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span>
    <span class="nx">startRocks</span> <span class="o">=</span> <span class="p">[...</span><span class="nc">Array</span><span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">StartRocksCount</span><span class="p">)]</span>
      <span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">_</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span><span class="o">=&gt;</span><span class="nf">createCircle</span><span class="p">(</span><span class="dl">"</span><span class="s2">rock</span><span class="dl">"</span><span class="p">)(</span><span class="nx">i</span><span class="p">)</span>
         <span class="p">(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">StartTime</span><span class="p">)(</span><span class="nx">Constants</span><span class="p">.</span><span class="nx">StartRockRadius</span><span class="p">)(</span><span class="nx">Vec</span><span class="p">.</span><span class="nx">Zero</span><span class="p">)</span>
         <span class="p">(</span><span class="k">new</span> <span class="nc">Vec</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">(),</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()))),</span>
    <span class="nx">initialState</span><span class="p">:</span><span class="nx">State</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">time</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
      <span class="na">ship</span><span class="p">:</span> <span class="nf">createShip</span><span class="p">(),</span>
      <span class="na">bullets</span><span class="p">:</span> <span class="p">[],</span>
      <span class="na">rocks</span><span class="p">:</span> <span class="nx">startRocks</span><span class="p">,</span>
      <span class="na">exit</span><span class="p">:</span> <span class="p">[],</span>
      <span class="na">objCount</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">StartRocksCount</span><span class="p">,</span>
      <span class="na">gameOver</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
</code></pre></div></div>

<h1 id="reducing-state-1">Reducing State</h1>

<p>Our <code class="language-plaintext highlighter-rouge">tick</code> function is more or less the same as above, but it will apply one more transformation to the state that it returns, by applying the following function.  This function checks for collisions between the ship and rocks, and also between bullets and rocks.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// check a State for collisions:</span>
    <span class="c1">//   bullets destroy rocks spawning smaller ones</span>
    <span class="c1">//   ship colliding with rock ends game</span>
    <span class="kd">const</span> <span class="nx">handleCollisions</span> <span class="o">=</span> <span class="p">(</span><span class="nx">s</span><span class="p">:</span><span class="nx">State</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span>
        <span class="c1">// Some array utility functions</span>
        <span class="nx">not</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="na">f</span><span class="p">:(</span><span class="na">x</span><span class="p">:</span><span class="nx">T</span><span class="p">)</span><span class="o">=&gt;</span><span class="nx">boolean</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">(</span><span class="na">x</span><span class="p">:</span><span class="nx">T</span><span class="p">)</span><span class="o">=&gt;!</span><span class="nf">f</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span>
        <span class="nx">mergeMap</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">T</span><span class="p">,</span> <span class="nx">U</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="na">a</span><span class="p">:</span> <span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="na">f</span><span class="p">:</span> <span class="p">(</span><span class="na">a</span><span class="p">:</span> <span class="nx">T</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="nx">U</span><span class="o">&gt;</span>
        <span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nf">concat</span><span class="p">(...</span><span class="nx">a</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">f</span><span class="p">)),</span>

        <span class="nx">bodiesCollided</span> <span class="o">=</span> <span class="p">([</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">]:[</span><span class="nx">Body</span><span class="p">,</span><span class="nx">Body</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">pos</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">pos</span><span class="p">).</span><span class="nf">len</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">radius</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">radius</span><span class="p">,</span>
        <span class="nx">shipCollided</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">rocks</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">r</span><span class="o">=&gt;</span><span class="nf">bodiesCollided</span><span class="p">([</span><span class="nx">s</span><span class="p">.</span><span class="nx">ship</span><span class="p">,</span><span class="nx">r</span><span class="p">])).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">allBulletsAndRocks</span> <span class="o">=</span> <span class="nf">mergeMap</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">bullets</span><span class="p">,</span> <span class="nx">b</span><span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">rocks</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">r</span><span class="o">=&gt;</span><span class="p">([</span><span class="nx">b</span><span class="p">,</span><span class="nx">r</span><span class="p">]))),</span>
        <span class="nx">collidedBulletsAndRocks</span> <span class="o">=</span> <span class="nx">allBulletsAndRocks</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nx">bodiesCollided</span><span class="p">),</span>
        <span class="nx">collidedBullets</span> <span class="o">=</span> <span class="nx">collidedBulletsAndRocks</span><span class="p">.</span><span class="nf">map</span><span class="p">(([</span><span class="nx">bullet</span><span class="p">,</span><span class="nx">_</span><span class="p">])</span><span class="o">=&gt;</span><span class="nx">bullet</span><span class="p">),</span>
        <span class="nx">collidedRocks</span> <span class="o">=</span> <span class="nx">collidedBulletsAndRocks</span><span class="p">.</span><span class="nf">map</span><span class="p">(([</span><span class="nx">_</span><span class="p">,</span><span class="nx">rock</span><span class="p">])</span><span class="o">=&gt;</span><span class="nx">rock</span><span class="p">),</span>

        <span class="c1">// spawn two children for each collided rock above a certain size</span>
        <span class="nx">child</span> <span class="o">=</span> <span class="p">(</span><span class="na">r</span><span class="p">:</span><span class="nx">Body</span><span class="p">,</span><span class="na">dir</span><span class="p">:</span><span class="kr">number</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">({</span>
          <span class="na">radius</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">radius</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
          <span class="na">pos</span><span class="p">:</span><span class="nx">r</span><span class="p">.</span><span class="nx">pos</span><span class="p">,</span>
          <span class="na">vel</span><span class="p">:</span><span class="nx">r</span><span class="p">.</span><span class="nx">vel</span><span class="p">.</span><span class="nf">ortho</span><span class="p">().</span><span class="nf">scale</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
        <span class="p">}),</span>
        <span class="nx">spawnChildren</span> <span class="o">=</span> <span class="p">(</span><span class="na">r</span><span class="p">:</span><span class="nx">Body</span><span class="p">)</span><span class="o">=&gt;</span>
                              <span class="nx">r</span><span class="p">.</span><span class="nx">radius</span> <span class="o">&gt;=</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">StartRockRadius</span><span class="o">/</span><span class="mi">4</span>
                              <span class="p">?</span> <span class="p">[</span><span class="nf">child</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="nf">child</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="nx">newRocks</span> <span class="o">=</span> <span class="nf">mergeMap</span><span class="p">(</span><span class="nx">collidedRocks</span><span class="p">,</span> <span class="nx">spawnChildren</span><span class="p">)</span>
          <span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">r</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span><span class="o">=&gt;</span><span class="nf">createCircle</span><span class="p">(</span><span class="dl">'</span><span class="s1">rock</span><span class="dl">'</span><span class="p">)(</span><span class="nx">s</span><span class="p">.</span><span class="nx">objCount</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)(</span><span class="nx">s</span><span class="p">.</span><span class="nx">time</span><span class="p">)(</span><span class="nx">r</span><span class="p">.</span><span class="nx">radius</span><span class="p">)(</span><span class="nx">r</span><span class="p">.</span><span class="nx">pos</span><span class="p">)(</span><span class="nx">r</span><span class="p">.</span><span class="nx">vel</span><span class="p">)),</span>

        <span class="c1">// search for a body by id in an array</span>
        <span class="nx">elem</span> <span class="o">=</span> <span class="p">(</span><span class="na">a</span><span class="p">:</span><span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="na">e</span><span class="p">:</span><span class="nx">Body</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nf">findIndex</span><span class="p">(</span><span class="nx">b</span><span class="o">=&gt;</span><span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">e</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="c1">// array a except anything in b</span>
        <span class="nx">except</span> <span class="o">=</span> <span class="p">(</span><span class="na">a</span><span class="p">:</span><span class="nx">ReadonlyArray</span><span class="o">&lt;</span><span class="nx">Body</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="na">b</span><span class="p">:</span><span class="nx">Body</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nf">filter</span><span class="p">(</span><span class="nf">not</span><span class="p">(</span><span class="nf">elem</span><span class="p">(</span><span class="nx">b</span><span class="p">)))</span>

      <span class="k">return</span> <span class="o">&lt;</span><span class="nx">State</span><span class="o">&gt;</span><span class="p">{</span>
        <span class="p">...</span><span class="nx">s</span><span class="p">,</span>
        <span class="na">bullets</span><span class="p">:</span> <span class="nf">except</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">bullets</span><span class="p">)(</span><span class="nx">collidedBullets</span><span class="p">),</span>
        <span class="na">rocks</span><span class="p">:</span> <span class="nf">except</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">rocks</span><span class="p">)(</span><span class="nx">collidedRocks</span><span class="p">).</span><span class="nf">concat</span><span class="p">(</span><span class="nx">newRocks</span><span class="p">),</span>
        <span class="na">exit</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">exit</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="nx">collidedBullets</span><span class="p">,</span><span class="nx">collidedRocks</span><span class="p">),</span>
        <span class="na">objCount</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">objCount</span> <span class="o">+</span> <span class="nx">newRocks</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="na">gameOver</span><span class="p">:</span> <span class="nx">shipCollided</span>
      <span class="p">}</span>
    <span class="p">},</span>
</code></pre></div></div>

<h1 id="final-view">Final View</h1>

<p>Finally, we need to update the <code class="language-plaintext highlighter-rouge">updateView</code> function.  Again, the view update is the one place in our program where we allow <span class="glossary-term" data-term="imperative">imperative<span class="glossary-popup">Imperative programs are a sequence of statements that change a program’s state.  This is probably the dominant paradigm for programming languages today.  Languages from Assembly to Python are built around this concept and most modern languages still allow you to program in this style.
</span></span> style, effectful code.  Called only from the subscribe at the very end of our <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> chain and not mutating any state that is read anywhere else in the <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span>, we ensure that it is not the source of any but the simplest display bugs, which we can hopefully diagnose with local inspection of this one function.</p>

<p>First, we need to update the visuals for each of the rocks, but these are the same as bullets.  The second, slightly bigger, change is simply to display the text “Game Over” on <code class="language-plaintext highlighter-rouge">s.gameover</code> true.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">function</span> <span class="nf">updateView</span><span class="p">(</span><span class="nx">s</span><span class="p">:</span> <span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">bullets</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">updateBodyView</span><span class="p">);</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">rocks</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">updateBodyView</span><span class="p">);</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">exit</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">o</span><span class="o">=&gt;</span><span class="p">{</span>
      <span class="kd">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="nx">svg</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">gameOver</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">subscription</span><span class="p">.</span><span class="nf">unsubscribe</span><span class="p">();</span>
      <span class="kd">const</span> <span class="nx">v</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElementNS</span><span class="p">(</span><span class="nx">svg</span><span class="p">.</span><span class="nx">namespaceURI</span><span class="p">,</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">;</span>
      <span class="nf">attr</span><span class="p">(</span><span class="nx">v</span><span class="p">,{</span>
        <span class="na">x</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">CanvasSize</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span>
        <span class="na">y</span><span class="p">:</span> <span class="nx">Constants</span><span class="p">.</span><span class="nx">CanvasSize</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="na">class</span><span class="p">:</span> <span class="dl">"</span><span class="s2">gameover</span><span class="dl">"</span>
      <span class="p">});</span>
      <span class="nx">v</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Game Over</span><span class="dl">"</span><span class="p">;</span>
      <span class="nx">svg</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>where we’ve created a little helper function <code class="language-plaintext highlighter-rouge">attr</code> to bulk set properties on an <code class="language-plaintext highlighter-rouge">Element</code>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span>
    <span class="nx">attr</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">:</span><span class="nx">Element</span><span class="p">,</span> <span class="nx">o</span><span class="p">:{</span> <span class="p">[</span><span class="nx">key</span><span class="p">:</span><span class="kr">string</span><span class="p">]:</span> <span class="nb">Object</span> <span class="p">})</span> <span class="o">=&gt;</span>
      <span class="p">{</span> <span class="k">for</span><span class="p">(</span><span class="kd">const</span> <span class="nx">k</span> <span class="k">in</span> <span class="nx">o</span><span class="p">)</span> <span class="nx">e</span><span class="p">.</span><span class="nf">setAttribute</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span><span class="nc">String</span><span class="p">(</span><span class="nx">o</span><span class="p">[</span><span class="nx">k</span><span class="p">]))</span> <span class="p">},</span>
</code></pre></div></div>

<p><em>Note that we need to specify the types of values inside <code class="language-plaintext highlighter-rouge">o</code>, otherwise, we will get an implicit any error.</em></p>

<p>The other thing happening at game over, is the call to <code class="language-plaintext highlighter-rouge">subscription.unsubscribe</code>.  This <code class="language-plaintext highlighter-rouge">subscription</code> is the object returned by the subscribe call on our main <span class="glossary-term" data-term="observable">Observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span>:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">subscription</span> <span class="o">=</span> <span class="nf">merge</span><span class="p">(</span>
    <span class="nf">interval</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nf">pipe</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nx">elapsed</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Tick</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">))),</span>
    <span class="nx">startLeftRotate</span><span class="p">,</span> <span class="nx">startRightRotate</span><span class="p">,</span> <span class="nx">stopLeftRotate</span><span class="p">,</span> <span class="nx">stopRightRotate</span><span class="p">,</span>
    <span class="nx">startThrust</span><span class="p">,</span> <span class="nx">stopThrust</span><span class="p">,</span>
    <span class="nx">shoot</span>
  <span class="p">)</span>
    <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span><span class="nf">scan</span><span class="p">(</span><span class="nx">reduceState</span><span class="p">,</span> <span class="nx">initialState</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nx">updateView</span><span class="p">);</span>
</code></pre></div></div>

<div class="alert-box alert-info">
  <p><strong>Key ingredients of a game in FRP style</strong></p>

  <p>This section here is key to FRP, with four key ingredients:</p>

  <ol>
    <li>A constant rate <em>interval</em> tick, to ensure consistent frame rate</li>
    <li><em>Merged</em> with Inputs from the user</li>
    <li><em>Scan</em> to update the state of the game</li>
    <li>Impure updates based on game state in <em>subscribe</em></li>
  </ol>

  <p>Any other game in FRP style, will likely involve an <em>almost</em> identical skeleton of:</p>

  <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">const</span> <span class="nx">subscription</span> <span class="o">=</span> <span class="nf">merge</span><span class="p">(</span>
    <span class="nf">interval</span><span class="p">(</span><span class="nx">FRAME_RATE</span><span class="p">).</span><span class="nf">pipe</span><span class="p">(</span><span class="nf">map</span><span class="p">(</span><span class="nx">elapsed</span><span class="o">=&gt;</span><span class="k">new</span> <span class="nc">Tick</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">))),</span>
    <span class="nx">USER_INPUT_STREAMS</span>
  <span class="p">)</span>
    <span class="p">.</span><span class="nf">pipe</span><span class="p">(</span><span class="nf">scan</span><span class="p">(</span><span class="nx">reduceState</span><span class="p">,</span> <span class="nx">INITIAL_GAME_STATE</span><span class="p">))</span>
    <span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="nx">updateView</span><span class="p">);</span>
</code></pre></div>  </div>

  <p>The job of the programmer (e.g., you in Assignment 1) will be to create appropriate functions to handle modification of the state, view, and inputs to ensure correct behaviour of the chosen game.</p>
</div>

<p>Finally, we need to make a couple more additions to the <span class="glossary-term" data-term="css">CSS<span class="glossary-popup">Cascading Style Sheets - another declarative (part of the HTML5 standard) for specifying reusable styles for web page rendering.
</span></span> to display the rocks and game over text:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.rock</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nx">burlywood</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.gameover</span> <span class="p">{</span>
  <span class="nl">font-family</span><span class="p">:</span> <span class="nb">sans-serif</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">80px</span><span class="p">;</span>
  <span class="py">fill</span><span class="p">:</span> <span class="nx">red</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At this point we have more or less all the elements of a game.  The implementation above could be extended quite a lot.  For example, we could add score, ability to restart the game, multiple lives, perhaps some more physics.  But generally, these are just extensions to the framework above: manipulation and then display of additional state.</p>

<p>The key thing is that the <span class="glossary-term" data-term="observable">observable<span class="glossary-popup">A data structure that represents a collection of future values or events, allowing for asynchronous data handling and reactive programming.
</span></span> has allowed us to keep well separated state management (model), its input and manipulation (control) and the visuals (view).  Further extensions are just additions within each of these elements—and doing so should not add greatly to the complexity.</p>

<p>I invite you to click through on the animations above, to the live code editor where you can extend or refine the framework I’ve started.</p>

	</div>
	
  

  


<div id="pagination">
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      
        
        
        <a id="left" href="/functionalreactiveprogramming/">&lt; <span class="glossary-term" data-term="functional">Functional<span class="glossary-popup">Functional languages are built around the concept of composable functions.  Such languages support <em>higher-order functions</em> which can take other functions as arguments or return new functions as their result, following the rules of the <em>Lambda Calculus</em>.
</span></span> Reactive Programming</a>
      
      
        
        
        <a id="right" href="/higherorderfunctions/"><span class="glossary-term" data-term="higher-order functions">Higher-Order Functions<span class="glossary-popup">A function that takes other functions as arguments or returns a function as its result.
</span></span> &gt;</a>
      
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</div>

</article>

      </div>
    </main><link id="fa-stylesheet" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css">
<footer class="site-footer h-card">
    <data class="u-url" href="/"></data>

    <div class="wrapper">

        <div class="footer-col-wrapper">
            <div class="footer-col">
                <!-- <p class="feed-subscribe">
                <a href="/feed.xml">
                    <svg class="svg-icon orange">
                        <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
                    </svg><span>Subscribe</span>
                </a>
                </p> -->
        </div>
        <div class="footer-col">
            <p>Examples and tutorials for various programming paradigms.</p>
        </div>
    </div>

    <!-- <div class="social-links"><ul class="social-media-list"><li>
    <a rel="me" href="" target="_blank" title="">
      <span class="grey fa-brands fa- fa-lg"></span>
    </a>
  </li><li>
    <a rel="me" href="" target="_blank" title="">
      <span class="grey fa-brands fa- fa-lg"></span>
    </a>
  </li>
  <li>
    <a href="/feed.xml" target="_blank" title="Subscribe to syndication feed">
      <svg class="svg-icon grey" viewbox="0 0 16 16">
        <path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194
          11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0
          13.806c0-1.21.983-2.195 2.194-2.195zM10.606
          16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"
        />
      </svg>
    </a>
  </li>
</ul>
</div> -->

    </div>

</footer>



</body></html>